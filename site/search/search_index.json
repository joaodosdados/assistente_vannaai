{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Assistente VANNAAI","text":"<p>Esta \u00e9 a documenta\u00e7\u00e3o do MVP do Assistente VANNAAI. Objetivo: permitir consultas em linguagem natural (PT\u2011BR) sobre processos via API, com guardrails de SQL e views de leitura no Postgres.</p>"},{"location":"#o-que-tem-aqui","title":"O que tem aqui","text":"<ul> <li>Setup por OS (incl. Windows/WSL2)</li> <li>Arquitetura com diagrama</li> <li>Esquema de dados (tabelas, views e mascaramento de PII)</li> <li>API com exemplos</li> <li>Guardrails de seguran\u00e7a</li> <li>Deploy com Docker Compose</li> <li>Observabilidade e Troubleshooting</li> </ul> <p>Para um tour r\u00e1pido, suba a API localmente e acesse <code>/docs</code> (OpenAPI).</p>"},{"location":"roadmap/","title":"Roadmap","text":"<ul> <li>[ ] Testes de regress\u00e3o para NLQ (perguntas fixas \u2192 resultados esperados)</li> <li>[ ] M\u00e9tricas Prometheus + dashboard</li> <li>[ ] Rate limiting por IP/chave</li> <li>[ ] Feature flags para NLQ vs. SQL est\u00e1tico</li> <li>[ ] Hardening de guardrails (parser/AST + pol\u00edticas)</li> <li>[ ] Pipeline CI (lint, testes, build)</li> </ul>"},{"location":"troubleshooting/","title":"Troubleshooting","text":""},{"location":"troubleshooting/#conexao-com-postgres-falhou","title":"Conex\u00e3o com Postgres falhou","text":"<ul> <li>O servi\u00e7o <code>db</code> est\u00e1 de p\u00e9? Porta <code>5432</code> livre?</li> <li><code>DATABASE_URL</code> correto? Tente: <code>psql &lt;connstring&gt;</code></li> </ul>"},{"location":"troubleshooting/#role-does-not-exist","title":"<code>role ... does not exist</code>","text":"<ul> <li>Crie role/usu\u00e1rio e permiss\u00f5es (ver Perfis de acesso).</li> </ul>"},{"location":"troubleshooting/#relation-does-not-exist","title":"<code>relation ... does not exist</code>","text":"<ul> <li>Execute o seed: <code>psql -d processos -f sql/init.sql</code></li> </ul>"},{"location":"troubleshooting/#uv-nao-encontrado","title":"<code>uv</code> n\u00e3o encontrado","text":"<ul> <li>Instale com <code>pipx install uv</code> ou gerenciador do seu OS.</li> </ul>"},{"location":"troubleshooting/#address-already-in-use","title":"<code>Address already in use</code>","text":"<ul> <li>A porta <code>8000</code> j\u00e1 est\u00e1 ocupada. Pare o processo antigo ou use <code>--port 8001</code>.</li> </ul>"},{"location":"api/","title":"API (FastAPI)","text":"<ul> <li>OpenAPI: <code>http://localhost:8000/docs</code></li> </ul>"},{"location":"api/#post-statusconsultar","title":"POST <code>/status/consultar</code>","text":"<p>Obt\u00e9m status do processo por <code>id_processo</code>.</p> <p>Body <pre><code>{\"id_processo\": \"123\"}\n</code></pre></p> <p>Resposta (exemplo) <pre><code>{\n  \"result\": [\n    {\n      \"id_processo\": \"123\",\n      \"status_atual\": \"Em an\u00e1lise\",\n      \"etapa_atual\": \"Valida\u00e7\u00e3o documental\",\n      \"dt_ult_atualizacao\": \"2025-08-31T14:12:00\"\n    }\n  ],\n  \"source\": \"assistente.vw_processo\"\n}\n</code></pre></p>"},{"location":"api/#post-nlq-opcional","title":"POST <code>/nlq</code> (opcional)","text":"<p>Pergunta em linguagem natural (PT\u2011BR) \u2192 SQL sugerido pelo Vanna \u2192 validado por guardrails e executado em views.</p> <p>Body <pre><code>{\"question\": \"mostrar status_atual e etapa_atual do processo 123\"}\n</code></pre></p> <p>Resposta (exemplo) <pre><code>{\n  \"result\": [\n    {\"status_atual\": \"Em an\u00e1lise\", \"etapa_atual\": \"Valida\u00e7\u00e3o documental\"}\n  ],\n  \"source\": \"assistente.vw_processo\"\n}\n</code></pre></p> <p>Notas: - Em dev, o NLQ pode ser desabilitado e voc\u00ea usa SQL est\u00e1tico. - Em prod, os guardrails s\u00e3o obrigat\u00f3rios.</p>"},{"location":"arquitetura/","title":"Arquitetura do MVP","text":"<pre><code>flowchart LR\nUser[Usu\u00e1rio / Cliente] --&gt;|HTTP JSON| FastAPI[FastAPI]\nFastAPI --&gt;|SQL (psycopg/asyncpg)| Postgres[(Postgres)]\nsubgraph NLQ (opcional)\nFastAPI --&gt; Vanna[VannaAI]\nVanna --&gt;|SQL gerado| Guardrails[Guardrails de SQL]\nGuardrails --&gt;|SQL seguro| Postgres\nend\nPostgres --&gt; Views[Views de leitura: schema assistente]\n</code></pre> <ul> <li>FastAPI exp\u00f5e endpoints REST.</li> <li>Postgres armazena tabelas base e views no schema <code>assistente</code> para leitura segura.</li> <li>Vanna (opcional) sugere SQL a partir de linguagem natural.</li> <li>Guardrails validam/limitam o SQL (somente <code>SELECT</code> em views aprovadas).</li> </ul>"},{"location":"arquitetura/#fluxos-principais","title":"Fluxos principais","text":""},{"location":"arquitetura/#statusconsultar","title":"<code>/status/consultar</code>","text":"<ol> <li>Recebe <code>id_processo</code>.</li> <li>Executa <code>SELECT</code> em <code>assistente.vw_processo</code>.</li> <li>Retorna <code>status_atual</code>, <code>etapa_atual</code>, <code>dt_ult_atualizacao</code>, <code>source</code>.</li> </ol>"},{"location":"arquitetura/#nlq-opcional","title":"<code>/nlq</code> (opcional)","text":"<ol> <li>Recebe <code>question</code> em PT\u2011BR.</li> <li>Vanna prop\u00f5e SQL.</li> <li>Guardrails validam (DDL/DML, schemas, fun\u00e7\u00f5es).</li> <li>Executa em view do schema <code>assistente</code> e retorna resultado + <code>source</code>.</li> </ol>"},{"location":"dados/esquema/","title":"Esquema, tabelas e views","text":""},{"location":"dados/esquema/#esquema-base","title":"Esquema base","text":"<ul> <li>Tabela: <code>public.processo</code></li> <li>Tabela: <code>public.evento_processo</code></li> </ul> <p>Essas tabelas representam o processo e seus eventos/altera\u00e7\u00f5es.</p>"},{"location":"dados/esquema/#views-de-leitura-schema-assistente","title":"Views de leitura (schema <code>assistente</code>)","text":"<ul> <li><code>assistente.vw_processo</code></li> <li>Colunas: <code>id_processo</code>, <code>status_atual</code>, <code>etapa_atual</code>, <code>dt_ult_atualizacao</code>, <code>cpf_mascarado</code>, ...</li> <li> <p>Aplica mascaramento de PII (ex.: CPF formatado <code>123***01</code>).</p> </li> <li> <p><code>assistente.vw_evento_processo</code></p> </li> <li>Colunas: <code>id_processo</code>, <code>evento</code>, <code>descricao</code>, <code>data_evento</code></li> </ul> <p>As views s\u00e3o a superf\u00edcie autorizada para consultas. A API n\u00e3o deve consultar tabelas diretamente em produ\u00e7\u00e3o.</p>"},{"location":"dados/esquema/#inicializacao-do-banco","title":"Inicializa\u00e7\u00e3o do banco","text":"<p><pre><code>psql -d processos -f sql/init.sql\n</code></pre> O script cria as tabelas e views com alguns dados de exemplo.</p>"},{"location":"dados/esquema/#convencoes","title":"Conven\u00e7\u00f5es","text":"<ul> <li>Todas as consultas da API devem usar o schema <code>assistente</code>.</li> <li>Evitar PII nos retornos; quando necess\u00e1rio, aplicar mascaramento nas views.</li> </ul>"},{"location":"deploy/docker/","title":"Deploy com Docker Compose","text":""},{"location":"deploy/docker/#subindo-tudo","title":"Subindo tudo","text":"<pre><code>docker compose up -d\ndocker compose logs -f\n</code></pre> <ul> <li>Servi\u00e7o db: <code>postgres:14</code>, volume <code>db_data</code>, seed via <code>sql/init.sql</code>.</li> <li>Servi\u00e7o api: build local, exp\u00f5e <code>8000</code> \u2192 <code>http://localhost:8000/docs</code></li> </ul>"},{"location":"deploy/docker/#encerrando","title":"Encerrando","text":"<pre><code>docker compose down -v\n</code></pre> <p>Dica: em dev, monte o diret\u00f3rio do projeto como volume para live reload.</p>"},{"location":"integracoes/vanna/","title":"Integra\u00e7\u00e3o com Vanna (opcional)","text":"<p>A integra\u00e7\u00e3o converte perguntas em PT\u2011BR em SQL. Fluxo: 1. Recebe <code>question</code>. 2. Gera SQL candidato (prompt engineering e few-shots espec\u00edficos do schema). 3. Passa pelo validador (guardrails). 4. Se aprovado, executa em <code>assistente.*</code>.</p>"},{"location":"integracoes/vanna/#configuracao","title":"Configura\u00e7\u00e3o","text":"<ul> <li>Habilite via vari\u00e1vel de ambiente (ex.: <code>ENABLE_VANNA=true</code>).</li> <li>Configure credenciais/chaves conforme a lib usada.</li> </ul>"},{"location":"integracoes/vanna/#boas-praticas","title":"Boas pr\u00e1ticas","text":"<ul> <li>Few-shots devem usar views do schema <code>assistente</code>.</li> <li>D\u00ea nomes autoexplicativos \u00e0s colunas das views.</li> <li>Mantenha um conjunto de perguntas de regress\u00e3o para testes.</li> </ul>"},{"location":"integracoes/vanna/#limitacoes-tipicas","title":"Limita\u00e7\u00f5es t\u00edpicas","text":"<ul> <li>Ambiguidade sem contexto.</li> <li>Joins n\u00e3o triviais entre views.</li> <li>Datas relativas (\u201c\u00faltima semana\u201d) exigem normaliza\u00e7\u00e3o.</li> </ul>"},{"location":"operacao/observabilidade/","title":"Observabilidade","text":""},{"location":"operacao/observabilidade/#logs","title":"Logs","text":"<ul> <li>N\u00edveis: <code>DEBUG</code> | <code>INFO</code> | <code>WARNING</code> | <code>ERROR</code></li> <li>Configure via <code>LOG_LEVEL</code> no <code>.env</code>.</li> <li>Registre:</li> <li>ID de correla\u00e7\u00e3o por requisi\u00e7\u00e3o.</li> <li>Nome da view consultada (<code>source</code>).</li> <li>Dura\u00e7\u00e3o da consulta e n\u00ba de linhas retornadas (sem dados sens\u00edveis).</li> </ul>"},{"location":"operacao/observabilidade/#saude","title":"Sa\u00fade","text":"<ul> <li>Endpoint <code>/healthz</code> (sugerido) para verificar conex\u00e3o com DB.</li> <li>Timeout de query configur\u00e1vel (ex.: 10s).</li> </ul>"},{"location":"operacao/observabilidade/#futuro","title":"Futuro","text":"<ul> <li>Expor m\u00e9tricas Prometheus (lat\u00eancia, throughput, erros).</li> </ul>"},{"location":"seguranca/guardrails/","title":"Guardrails de SQL","text":""},{"location":"seguranca/guardrails/#politicas","title":"Pol\u00edticas","text":"<ul> <li>Somente <code>SELECT</code> \u00e9 permitido.</li> <li>Somente views do schema <code>assistente</code> podem ser acessadas.</li> <li>Proibido: DDL/DML (<code>INSERT</code>, <code>UPDATE</code>, <code>DELETE</code>, <code>DROP</code>, <code>ALTER</code>), <code>COPY</code>, <code>CREATE</code>, <code>GRANT</code>, etc.</li> <li>Proibido: acesso a outros schemas (<code>public</code>, <code>pg_catalog</code>, <code>information_schema</code>, ...).</li> <li>Proibido: fun\u00e7\u00f5es perigosas, <code>;</code> m\u00faltiplos statements, CTEs que escapem da policy.</li> <li>LIMIT padr\u00e3o pode ser aplicado (ex.: 500) para evitar resultados gigantes.</li> </ul>"},{"location":"seguranca/guardrails/#estrategia-de-validacao","title":"Estrat\u00e9gia de valida\u00e7\u00e3o","text":"<ol> <li>Parse do SQL (AST) para garantir somente <code>SELECT</code>.</li> <li>Lista branca de objetos: <code>assistente.vw_*</code>.</li> <li>Static checks (schema, fun\u00e7\u00f5es, m\u00faltiplas instru\u00e7\u00f5es).</li> <li>Runtime checks (timeout, row limit).</li> </ol>"},{"location":"seguranca/guardrails/#exemplos","title":"Exemplos","text":"<p>Pergunta segura:</p> <p>\"listar <code>status_atual</code>, <code>etapa_atual</code> do processo 123\"</p> <p>Pergunta bloqueada:</p> <p>\"apague a tabela processo\" \u2192 DDL/DML proibido.</p>"},{"location":"seguranca/perfis/","title":"Perfis de acesso (roles)","text":""},{"location":"seguranca/perfis/#desenvolvimento","title":"Desenvolvimento","text":"<ul> <li>Usu\u00e1rio app com permiss\u00f5es de leitura no schema <code>assistente</code>.</li> <li>Permiss\u00f5es de escrita usadas apenas por scripts de seed.</li> </ul>"},{"location":"seguranca/perfis/#producao-recomendado","title":"Produ\u00e7\u00e3o (recomendado)","text":"<ul> <li><code>role_assistente_ro</code>: <code>USAGE</code> no schema <code>assistente</code> e <code>SELECT</code> nas views.</li> <li>Usu\u00e1rio da API pertence apenas a <code>role_assistente_ro</code>.</li> <li>Sem privil\u00e9gios de escrita/tabelas base.</li> </ul>"},{"location":"seguranca/perfis/#exemplo-ajuste-para-seu-ambiente","title":"Exemplo (ajuste para seu ambiente)","text":"<pre><code>-- criar role somente leitura\nCREATE ROLE role_assistente_ro;\nGRANT USAGE ON SCHEMA assistente TO role_assistente_ro;\nGRANT SELECT ON ALL TABLES IN SCHEMA assistente TO role_assistente_ro;\nALTER DEFAULT PRIVILEGES IN SCHEMA assistente GRANT SELECT ON TABLES TO role_assistente_ro;\n\n-- vincular usu\u00e1rio da API\nGRANT role_assistente_ro TO usuario_api;\n</code></pre>"},{"location":"setup/","title":"Setup do ambiente","text":"<p>Pr\u00e9-requisitos</p> <ul> <li>Python 3.11+</li> <li>Postgres 14+</li> <li><code>uv</code> (gerenciador de depend\u00eancias Python)</li> <li>(Opcional) Docker + Docker Compose</li> </ul>"},{"location":"setup/#macos","title":"macOS","text":"<pre><code># Postgres (Homebrew) e uv\nbrew install postgresql@14\nbrew services start postgresql@14\n\n# Banco e seed\ncreatedb processos\npsql -d processos -f sql/init.sql\n\n# Depend\u00eancias\nuv sync\n\n# Executar API\nuv run uvicorn app.main:app --reload --port 8000\n# OpenAPI: http://localhost:8000/docs\n</code></pre>"},{"location":"setup/#windows-wsl2-recomendado","title":"Windows (WSL2 recomendado)","text":"<ol> <li>Instale WSL2 + Ubuntu pela Microsoft Store.</li> <li>Dentro do Ubuntu: <pre><code>sudo apt update &amp;&amp; sudo apt install -y postgresql postgresql-contrib python3.11 python3.11-venv pipx\nsudo -u postgres createuser -s $USER || true\ncreatedb processos\npsql -d processos -f sql/init.sql\n\npipx install uv\nuv sync\nuv run uvicorn app.main:app --reload --port 8000 --host 0.0.0.0\n</code></pre></li> </ol>"},{"location":"setup/#windows-sem-wsl","title":"Windows (sem WSL)","text":"<ul> <li>Instale Postgres pelo instalador oficial (incluir <code>psql</code> no PATH), Python 3.11 e <code>pipx</code>.</li> <li><code>pipx install uv</code></li> <li>Siga os mesmos comandos de sync e execu\u00e7\u00e3o acima.</li> </ul>"},{"location":"setup/#variaveis-de-ambiente","title":"Vari\u00e1veis de ambiente","text":"<p>Crie um <code>.env</code> na raiz (apenas se usar conex\u00e3o customizada): <pre><code>DATABASE_URL=postgresql://usuario:senha@localhost:5432/processos\nAPP_ENV=dev\nLOG_LEVEL=INFO\n</code></pre> Se ausente, a app usa valores padr\u00e3o do <code>settings</code>.</p>"}]}